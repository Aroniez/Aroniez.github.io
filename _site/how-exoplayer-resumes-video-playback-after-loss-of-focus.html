<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>How ExoPlayer Resumes Video Playback After Loss of Focus</title>
    <meta name="description" content="After attending the most recent Android Developers Meetup in New York City and hearing about ExoPlayer2 (a great talk given by @kylevenn!) I really wanted to...">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://int-a.github.io/how-exoplayer-resumes-video-playback-after-loss-of-focus">
    <link rel="alternate" type="application/rss+xml" title="Anthony Intino" href="http://int-a.github.io/feed.xml" />
  </head>

  <body>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-64334623-1', 'auto');
  ga('send', 'pageview');

</script>

    <main>
      <header class="site-header">
  <div class="container">
    <h1><a href="/">Anthony<span>Intino</span></a></h1>

    <button type="button" class="sliding-panel-button">
      <span></span>
      <span></span>
      <span></span>
    </button>

    <nav class="navbar sliding-panel-content">
      <ul>
        
          <li><a href="/about" title="About">About</a></li>
        
          <li><a href="/resume" title="Resume">Resume</a></li>
        
          <li><a href="/blog" title="Blog">Blog</a></li>
        
      </ul>
    </nav>
  </div>
</header>

<div class="sliding-panel-fade-screen"></div>


      <div class="container">
        <article role="article" class="post">

  <div class="card">
    <header class="post-header">
      <h1 class="post-title">How ExoPlayer Resumes Video Playback After Loss of Focus</h1>
      <p class="post-meta">Jun 4, 2017</p>
    </header>

    <div class="post-content">
      <p>After attending the most recent <a href="https://www.meetup.com/nyandroiddevelopers/">Android Developers Meetup</a> in New York City and hearing about ExoPlayer2 (a great talk given by <a href="https://twitter.com/kylevenn?lang=en">@kylevenn</a>!) I really wanted to implement it in my app. ExoPlayer is an alternative to the basic <code>MediaPlayer</code> provided by the Android framework. In short, ExoPlayer is MUCH more extensible and customizable than <code>MediaPlayer</code>. The basic building blocks of ExoPlayer, <code>MediaSource</code> , <code>TrackSelector</code>, and <code>LoadControl</code> can call be customized to suit your needs. For more on this check out Google’s <a href="https://google.github.io/ExoPlayer/guide.html">ExoPlayer Developer Guide</a>.</p>

<p>For my app I really didn’t need anything too fancy, but I wanted to learn ExoPlayer and get familiar with it. I figured using the default implementations of the various components would be just fine. After implementing the most barebones version of ExoPlayer I quickly realized that when navigating away from my app during video playback and coming back resulted in a black screen, not exactly ideal. I needed the video to resume playing from where I left off.</p>

<p>Luckily ExoPlayer is open source and also provides a demo application in their repo. So after poking around the <a href="https://github.com/google/ExoPlayer/blob/release-v2/demo/src/main/java/com/google/android/exoplayer2/demo/PlayerActivity.java">PlayerActivity</a> it became apparent how this is done.</p>

<p>When an Activity is no longer visible to the user the <code>onStop()</code> method is called, if a user presses the home button, keeping the Activity in memory, then <code>onStop()</code> is the last event in this callback chain. If the user were to press the back button instead the Activity would be destroyed, calling <code>onDestroy()</code> and then <code>onCreate()</code> again when the user goes back to a given Activity, in this case we would not want to save video playback since the user has completely exited the Activity and came back, potentially loading an entirely different video. However, in the case of hitting the Home button it is possible the user simply wanted to check something quick in another app and come back to the video they were watching. Here <code>onDestroy()</code> and <code>onCreate()</code> would not be called since the Activity remains in memory.</p>

<p>In the <code>onStop()</code> code of <code>PlayerActivity</code> <code>releasePlayer()</code> is called.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">releasePlayer</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">player</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">debugViewHelper</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
    <span class="n">debugViewHelper</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">shouldAutoPlay</span> <span class="o">=</span> <span class="n">player</span><span class="o">.</span><span class="na">getPlayWhenReady</span><span class="o">();</span>
    <span class="n">updateResumePosition</span><span class="o">();</span>
    <span class="n">player</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
    <span class="n">player</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">trackSelector</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">trackSelectionHelper</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">eventLogger</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>In <code>releasePlayer()</code> the <code>updateResumePosition()</code> method is called.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">updateResumePosition</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">resumeWindow</span> <span class="o">=</span> <span class="n">player</span><span class="o">.</span><span class="na">getCurrentWindowIndex</span><span class="o">();</span>
  <span class="n">resumePosition</span> <span class="o">=</span> <span class="n">player</span><span class="o">.</span><span class="na">isCurrentWindowSeekable</span><span class="o">()</span> <span class="o">?</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">player</span><span class="o">.</span><span class="na">getCurrentPosition</span><span class="o">())</span>
      <span class="o">:</span> <span class="n">C</span><span class="o">.</span><span class="na">TIME_UNSET</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>Here the player window and video position are saved to global variables.</p>

<p>Then, when the Acitivity comes back into the user’s view <code>onStart()</code> is called, in <code>onStart()</code> the <code>initializePlayer()</code> method is called which contains some logic to check the <code>resumeWindow</code> variable:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kt">boolean</span> <span class="n">haveResumePosition</span> <span class="o">=</span> <span class="n">resumeWindow</span> <span class="o">!=</span> <span class="n">C</span><span class="o">.</span><span class="na">INDEX_UNSET</span><span class="o">;</span>
<span class="k">if</span> <span class="o">(</span><span class="n">haveResumePosition</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">player</span><span class="o">.</span><span class="na">seekTo</span><span class="o">(</span><span class="n">resumeWindow</span><span class="o">,</span> <span class="n">resumePosition</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>This will check <code>resumeWindow</code> to see if it is not the default value (<a href="https://google.github.io/ExoPlayer/doc/reference/com/google/android/exoplayer2/C.html#INDEX_UNSET">C.INDEX_UNSET</a>) and if not it will load the saved window and seek to the saved position. And that’s it! The video has now been resumed where the user left off.</p>

<p>Also note that <code>clearResumePosition()</code> is called in <code>onCreate()</code> because <code>onCreate()</code> will only get called again once the Activity gets destroyed and recreated. In this case we do not want to resume playback.</p>

    </div>

    
<hr>

<aside id="comments" class="disqus">
  <div class="container">
    <h3><i class="icon icon-comments-o"></i> Comments</h3>
    <div id="disqus_thread"></div>
    <script>
      var disqus_config = function() {
        this.page.url = 'http://int-a.github.io';
        this.page.identifier = '/how-exoplayer-resumes-videoeoplayback-after-loss-of-focus';
      };
      (function() {
        var d = document,
        s = d.createElement('script');
        s.src = '//aroniez.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</aside>

  </div>

</article>

      </div>

      <footer class="site-footer">
  <div class="container">
    <ul class="social">
  <li><a href="http://github.com/int-a" target="_blank"><i class="icon icon-github"></i></a></li>
  <li><a href="https://www.linkedin.com/in/afi3rd/" target="_blank"><i class="icon icon-linkedin"></i></a></li>
</ul>

    <p class="txt-medium-gray">
      <small>&copy;2017 All rights reserved. Made with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and ♥</small>
    </p>
  </div>
</footer>


      <a href="http://github.com/int-a" target="_blank" class="github-corner"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#337ab7; color:#fff; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

      <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
      <script>
      $(document).ready(function() {
        $('.sliding-panel-button,.sliding-panel-fade-screen,.sliding-panel-close').on('click touchstart',function (e) {
          $('.sliding-panel-content,.sliding-panel-fade-screen').toggleClass('is-visible');
          e.preventDefault();
        });
      });
      </script>
    </main>
  </body>
</html>
